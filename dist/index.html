<style>*{font-family:monospace}body{margin:0;background:#111;color:whitesmoke}.container{margin-bottom:100px}.header{margin-bottom:10px}.canvas-container{width:100%;text-align:center}canvas{display:inline}.buttons{display:hidden}@media(max-width:900px){.buttons{display:grid;margin-top:50px;grid-template-columns:1fr 1fr;justify-items:center;align-items:center}.button{background:#333;border-radius:50%;width:150px;height:150px}.container{margin-bottom:0}}@media all and (display-mode:fullscreen){.header{display:none}.buttons{display:none}}</style><title>13kb JS Shmup</title><div class="container"><div class="header"><h1>13kb JS Shmup</h1><p>Move with arrow keys. Shoot with Z<div class="debug"><button onclick="debug.gameReset()">Reset(R)</button> <button onclick="debug.enginePause()">Pause/Advance(P)</button> <button onclick="debug.engineStart()">Resume(Enter)</button> <button onclick="debug.toggleHitboxes()">Hitboxes(H)</button> <button onclick="debug.toggleFullScreen()">Full Screen(F11)</button></div></div><div class="canvas-container"><canvas></canvas></div></div><div class="buttons"><div class="button analog"></div><div class="button shot"></div></div><script>"use strict";let zzfx,zzfxV,zzfxX,M=(zzfxV=.3,zzfx=(t=1,e=.05,s=220,i=0,h=0,a=.1,o=0,r=1,n=0,l=0,d=0,p=0,c=0,g=0,u=0,f=0,y=0,m=1,x=0,b=0)=>{let w=Math,v=44100,S=2*w.PI,P=n*=500*S/v/v,B=s*=(1-e+2*e*w.random(e=[]))*S/v,E=0,z=0,A=0,k=1,F=0,M=0,R=0,T,I;for(l*=500*S/v**3,u*=S/v,d*=S/v,p*=v,c=v*c|0,I=(i=v*i+9)+(x*=v)+(h*=v)+(a*=v)+(y*=v)|0;A<I;e[A++]=R)++M%(100*f|0)||(R=o?1<o?2<o?3<o?w.sin((E%S)**3):w.max(w.min(w.tan(E),1),-1):1-(2*E/S%2+2)%2:1-4*w.abs(w.round(E/S)-E/S):w.sin(E),R=(c?1-b+b*w.sin(S*A/c):1)*(0<R?1:-1)*w.abs(R)**r*t*zzfxV*(A<i?A/i:A<i+x?1-(A-i)/x*(1-m):A<i+x+h?m:A<I-y?(I-A-y)/a*m:0),R=y?R/2+(y>A?0:(A<I-y?1:(I-A)/y)*e[A-y|0]/2):R),T=(s+=n+=l)*w.cos(u*z++),E+=T-T*g*(1-1e9*(w.sin(A)+1)%2),k&&++k>p&&(s+=d,B+=d,k=0),!c||++F%c||(s=B,n=P,k=k||1);return(t=zzfxX.createBuffer(1,I,v)).getChannelData(0).set(e),(s=zzfxX.createBufferSource()).buffer=t,s.connect(zzfxX.destination),s.start(),s},zzfxX=new(window.AudioContext||webkitAudioContext),Math);class CustomMath{toRadians(t){return t*M.PI/180}randomBetween(t,e){return M.floor(M.random()*(e-t+1)+t)}}class Assets{constructor(){}getPalettesArr(){return[{99:[243,119,250],60:[129,0,115],39:[35,23,139]},{99:[59,187,250],60:[0,127,135],39:[0,0,167]},{99:[59,187,250],60:[0,127,135],39:[79,79,79]},{99:[155,250,239],60:[0,127,135],39:[0,59,19]},{99:[239,187,59],60:[199,70,95],39:[31,55,235]},{99:[127,207,15],60:[0,147,0],39:[79,79,79]},{99:[250,151,55],60:[199,75,11],39:[23,59,91]},{99:[254,254,254],60:[250,178,0],39:[0,78,180]},{99:[142,187,255],60:[106,156,255],39:[67,126,229]},{99:[64,81,65],60:[32,23,85],39:[53,46,95]}]}getSpriteSizes(){let e=0,s=[],t=[{w:8,h:15},{w:6,h:15},{w:6,h:15},{w:7,h:13},{w:6,h:13},{w:7,h:11},{w:6,h:8},{w:4,h:8},{w:1,h:7}];t.forEach(t=>{t.sourceX=e,e+=t.w,t.fullW=2*t.w-1});for(let e=0;e<6;e++)t.forEach(t=>s.push({...t,offset:e+1}));return t.push(...s,{fullW:72,h:8,bg:"bg"}),t}load(t){this.assetsReady=t,this.palettes=this.getPalettesArr();const e=this.getSpriteSizes();this.remainingGraphicsToLoad=e.length,e.forEach((r,s)=>{let n=new Image;n.src=r.bg?"img/bg.webp":"img/sprites.webp",n.onload=()=>{let i=document.createElement("canvas"),h=i.getContext("2d"),t=(i.width=r.fullW,i.height=r.h,r.bg?h.drawImage(n,0,0):[0,1].forEach(t=>{h.scale(t?-1:1,1),h.drawImage(n,r.sourceX+(r.offset||0),0,r.w,r.h,t?1-r.w:0,0,t?-r.w:r.w,r.h)}),h.getImageData(0,0,i.width,i.height)),a=t.data,o=[];i.width=i.width*this.palettes.length,this.palettes.forEach((t,e)=>{for(let t=0;t<a.length;t+=4)0<a[t]&&(o[t+3]=255,o.splice(t,3,...this.palettes[e][a[t]]||[0,0,0]));let s=h.createImageData(i.width/this.palettes.length,i.height);o.forEach((t,e)=>s.data[e]=t),h.putImageData(s,e*r.fullW,0)});var e=r.bg||s;this[e]=new Image,this[e].src=i.toDataURL(),this[e].sWidth=r.fullW,r.bg&&(this.bg.width=r.fullW),r.bg&&(this.bg.height=r.h),this[e].onload=()=>this.countDown()}})}countDown(){this.remainingGraphicsToLoad--,0===this.remainingGraphicsToLoad&&this.assetsReady()}}class Entity{constructor(t){this.free=!0,this.image=t,this.width=t?.sWidth||1,this.height=t?.height||1,this.hitbox=new Array(4),this.timers=new Array(9),this.math=customMath,this.queue=game.queuedFns,this.sfxFlags=game.sfxFlags,this.displayWidth=display.width,this.displayHeight=display.height}parentReset(t){return this.hp=1,this.deadBound=!1,this.hitState=0,this.opacity=100,this.rotation=0,this.scale=1,t?.palette&&(this.palette=t.palette),this.timers.fill(0),this.dying=!1,this.explode=!1,this.carryItem=t?.carryItem||!1,this.reset1?.(t),this.reset2?.(t),this.hitbox&&this.updateHitbox(),this}setupHitbox(t=this.width/2,e=this.height/2,s=0,i=0){this.xMargin=t,this.yMargin=e,this.xOffset=s,this.yOffset=i}updateHitbox(){this.hitbox[0]=this.x-this.xMargin+this.xOffset,this.hitbox[1]=this.x+this.xMargin+this.xOffset,this.hitbox[2]=this.y-this.yMargin+this.yOffset,this.hitbox[3]=this.y+this.yMargin+this.yOffset}spawnParticles(e,s){for(let t=0;t<e.qty;t++)this.queue.push(["Particle",e.options,s])}releaseItem(){this.carryItem&&this.explode&&this.queue.push(["Item",{x:this.x,y:this.y}])}timerCount(t=9999,e=0){if(this.timers[e]===t)return!0;this.timers[e]<t&&(this.timers[e]+=1)}vectorMovement(){this.x+=M.cos(this.angle)*this.speed,this.y-=M.sin(this.angle)*this.speed}bgMovement(t,e){this.x+=t,this.y+=this.stage.bg.speed+e}updatePos(){this.vectorMovement()}}class Player extends Entity{constructor(t){super(t),this.palette=7,this.layer="Players",this.setupHitbox(2,2,0,2),this.explosionData=function(){return{qty:40,options:{x:this.x,y:this.y,speed:4}}},this.shotTime=6}reset1(){this.outOfBounds=!1,this.x=this.displayWidth/2,this.y=95}updateData(t){if(0<t[4]&&this.timers[0]===this.shotTime){var e=[{x:this.x,y:this.y-6,offset:4},{x:this.x,y:this.y-6,offset:-4},{x:this.x+7,y:this.y-4,angle:1.0472,rotation:5.2359,hitbox:[1,2]},{x:this.x-7,y:this.y-4,angle:2.0944,rotation:4.1887,hitbox:[1,2]}];for(let t=0;t<4;t++)this.queue.push(["PlayerBullet",e[t]]);this.sfxFlags.pShot=!0,this.timers[0]=0}this.timerCount(this.shotTime)}updatePos(t){t[this.angle=0]&&(this.angle=1.57),t[1]&&(this.angle=6.283),t[2]&&(this.angle=4.712),t[3]&&(this.angle=3.141),t[0]&&t[1]&&(this.angle=.785),t[1]&&t[2]&&(this.angle=5.497),t[2]&&t[3]&&(this.angle=3.926),t[0]&&t[3]&&(this.angle=2.356),(t[0]&&t[2]||t[1]&&t[3])&&(this.angle=0),this.speed=this.angle?1.5:0,this.vectorMovement()}fixOutOfBounds(){this.y<3&&(this.y=3),113<this.y&&(this.y=113),155<this.x&&(this.x=155),this.x<5&&(this.x=5)}positionFar(){this.x=this.displayWidth/2,this.y=this.displayHeight+99}}class PlayerBullet extends Entity{constructor(t){super(t),this.palette=1,this.layer="pBullets",this.speed=6}reset1(t){this.deadBound=!0,t?.hitbox?this.setupHitbox(...t.hitbox):this.setupHitbox(),this.x=t.x+(t.offset||0),this.y=t.y,this.rotation=t.rotation+1.5708||0,this.angle=t.angle||1.5708}}class AccessToPlayer extends Entity{constructor(t){super(t),this.player=pool.type.Player[0]}}class Enemy extends AccessToPlayer{constructor(t){super(t),this.layer="E_Air",this.explosionData=function(){return{qty:9,options:{x:this.x,y:this.y}}},this.killAnimation=!1,this.stage=stage}reset1(t){this.x=t?.x||this.displayWidth/2,this.y=t?.y||-this.height/2,this.side=t?.side||1,this.phase=t?.phase||1,this.speed=t?.speed||1,this.alt=t?.alt||!1}shot(e=1,s,i,h,a=0,o=0,t){for(let t=0;t<e;t++)this.queue.push(["EnemyBullet",{x:this.x+a,y:this.y+o,speed:s,angle:i||270+t*(360/e),add:h*(t-M.floor(e/2))||0}]);this.sfxFlags[t||"eShot"]=!0}commonBoom(t,e,s){this.hitState=this.timers[8]%4?1:0,this.dying=!0,this.timers[8]%t==0&&this.timers[8]<100&&(this.spawnParticles({qty:e,options:{x:this.x+this.math.randomBetween(-this.width/2,this.width/2),y:this.y+this.math.randomBetween(-this.height/2,this.height/2),speed:1,subSpdRange:[.5,1],colors:s}}),this.sfxFlags.xplos_S=!0),this.timerCount(999,8)}smokeBoom(){this.commonBoom(10,4,["#eee","#ddd","#ccc","#bbb"]),this.y+=.2,this.scale-=.005,60===this.timers[8]&&(this.spawnParticles({qty:20,options:{x:this.x,y:this.y}}),this.sfxFlags.xplos_L=!0,this.free=!0)}stutterBoom(){this.commonBoom(20,15),this.y+=.1,this.timers[8]<100&&(this.x+=this.math.randomBetween(-1,1)),100===this.timers[8]&&(this.spawnParticles({qty:150,options:{x:this.x,y:this.y,speed:2}}),this.sfxFlags.xplos_L=!0),110===this.timers[8]&&(this.spawnParticles({qty:100,options:{x:this.x,y:this.y}}),this.spawnParticles({qty:50,options:{x:this.x,y:this.y,speed:6}}),this.sfxFlags.xplos_L=!0,this.free=!0)}easeOutCubic(t,e,s,i,h=0){this[t]=(s-e)*(1-M.pow(1-this.timers[h]/i,3))+e}easeInOutSine(t,e,s,i,h=0){this[t]=(s-e)*(-(M.cos(M.PI*this.timers[h]/i)-1)/2)+e}sin(t,e,s=1,i=0,h=0){this[t]=M.sin(this.math.toRadians(this.timers[h])/s)*e/2+i}cos(t,e,s=1,i=0,h=0,a=1){this[t]=a*M.cos(this.math.toRadians(this.timers[h])/s)*e+i}}class BigTank extends Enemy{constructor(t){super(t),this.palette=8,this.setupHitbox(this.width-2,this.height-5),this.layer="E_Land",this.killAnimation=this.stutterBoom}reset2(){this.scale=2,this.hp=70,this.speed=.2,this.pos=1,this.amp=1}updateData(){[1,-1].forEach(t=>{this.spawnParticles({qty:1,options:{x:this.x+6*t,y:this.y,colors:["#443","#454","#432"],speed:1===this.pos?2.5:3.5,scale:8,angle:1===this.pos?this.math.toRadians(this.math.randomBetween(30,150)):this.math.toRadians(this.math.randomBetween(250,290))}},"Floor")}),2===this.pos&&this.timers[1]%(30<this.hp?25:20)==0&&this.shot(30<this.hp?7:8,1.3,0,0,0,12,"cannon")}updatePos(){1===this.pos&&(this.cos("y",40,this.speed,0,0,-1),this.speed+=.004,this.timerCount(100,0),100===this.timers[0]&&this.pos++),2===this.pos&&(this.cos("y",8.9,this.speed,30,1,1),this.sin("x",this.amp,.9,80,1),this.timers[1]<80&&this.amp++,this.timerCount(9999,1))}}class EnemyBullet extends Enemy{constructor(){super(),this.layer="eBullets",this.setupHitbox(1,1),this.explosionData=()=>!1,this.currentColor="#ff7"}reset2(t){this.deadBound=!0,this.scale=3,"auto"===t?.angle?this.angle=M.atan2(this.y-this.player.y,this.player.x-this.x):this.angle=this.math.toRadians(t?.angle||0),this.angle+=this.math.toRadians(t?.add)||0}updateData(){this.spawnParticles({qty:1,options:{x:this.x,y:this.y,speed:0,scale:2.5,opacity:55,colors:["#ffe","#ffd","#ffc"],beheavior:3}}),this.rotation+=this.math.toRadians(10)}}class SinePop extends Enemy{constructor(t){super(t),this.palette=6,this.setupHitbox(this.height/2,this.height/2-1,0,-1)}updatePos(){this.cos("x",75,.6,80,0,this.phase),this.timerCount(),this.y+=.5}}class Sniper extends Enemy{constructor(t){super(t),this.palette=0,this.setupHitbox(this.width/2-1,this.height/2-1)}reset2(){this.hp=3,this.speed=1.5,this.scale=1.2}updateData(){this.timerCount(100),this.timers[0]<50&&(this.speed-=.025),60===this.timers[0]&&(this.alt?this.shot(7,1):this.shot(1,1.3,"auto",0,-1,4)),100===this.timers[0]&&(this.speed+=.02)}updatePos(){this.y+=this.speed}}class Fatty extends Enemy{constructor(t){super(t),this.palette=5,this.setupHitbox(5,5)}reset2(){this.hp=4,this.x=this.displayWidth/2-(this.displayWidth/2+this.width/2)*this.side}updateData(){this.timerCount(80),70===this.timers[0]&&(this.alt?this.shot(1,1.5,"auto"):this.shot(3,1.3,"auto",20))}updatePos(){this.x+=.75*this.speed*this.side,this.y+=.25*this.speed}}class Tank extends Enemy{constructor(t){super(t),this.palette=6,this.setupHitbox(this.width/2,this.height/2-2),this.layer="E_Land"}reset2(){this.hp=3}updatePos(){this.bgMovement(0,.1)}}class Assaulter extends Enemy{constructor(t){super(t),this.palette=4,this.setupHitbox(10,10),this.killAnimation=this.smokeBoom}reset2(){this.hp=22,this.speed=2.5,this.angle=M.atan2(this.y-this.player.y,this.player.x-this.x),this.scale=1.5}updateData(){this.timerCount(100),this.timers[0]<25&&(this.speed-=.1),40===this.timers[0]&&this.shot(10,1),80===this.timers[0]&&(this.shot(3,1.5,"auto",20),this.angle=M.atan2(this.y-this.player.y,this.player.x-this.x)),80<this.timers[0]&&(this.speed+=.02)}}class Boat extends Enemy{constructor(t){super(t),this.palette=1,this.setupHitbox()}reset2(){this.hp=4}updateData(){this.timerCount(110),this.timers[0]%10==0&&39<this.timers[0]&&this.timers[0]<81&&this.shot(1,1,"auto")}updatePos(){this.bgMovement(.05*this.side,.05)}}class Particle extends AccessToPlayer{constructor(){super(),this.layer="Parts",this.hitbox=0}reset1(t){this.deadBound=!0,this.x=t?.x,this.y=t?.y,this.scale=t?.scale||4,this.speed=t?.speed??3,this.subSpdRange=t?.subSpdRange||[1,2],this.angle=t?.angle??this.math.toRadians(this.math.randomBetween(1,360)),this.rotateDir=this.math.randomBetween(0,1)?-1:1,this.colors=t?.colors||["#f61","#fd7","#ff9","#feb","#ffc","#ffe"],this.currentColor=this.colors[this.math.randomBetween(0,this.colors.length-1)],this.opacity=t?.opacity||100,this.beheavior=t?.beheavior||1}updateData(){if(this.scale<=0||this.opacity<=0)return this.hp=0;this.rotation+=.08*this.rotateDir,this.opacity-=5,this["beheavior"+this.beheavior]()}updatePos(){this.vectorMovement()}beheavior1(){this.scale-=.2,this.speed-=this.math.randomBetween(...this.subSpdRange)/10}beheavior2(){this.x=this.player.x,this.y=this.player.y,this.scale+=4}beheavior3(){this.scale-=.2}}class Item extends Entity{constructor(t){super(t),this.setupHitbox(),this.layer="Pickups",this.colors=["#9ff","#aff","#bff","#dff","#eff"],this.explosionData=function(){return{qty:30,options:{x:this.x,y:this.y,colors:this.colors}}},this.speed=1,this.angle=this.math.toRadians(-90)}reset1(t){this.x=t?.x||this.displayWidth/2,this.y=t?.y||-this.height/2,this.ySpd=3,this.scale=0}updateData(){this.palette=this.math.randomBetween(1,3),this.scale<1&&(this.scale+=.1),this.timers[0]%2==0&&this.spawnParticles({qty:1,options:{x:this.x,y:this.y,colors:this.colors,speed:2.5,scale:3.5,angle:this.math.toRadians(this.math.randomBetween(0,180))}}),this.timerCount(999)}updatePos(){this.y-=this.ySpd,0<=this.ySpd&&(this.ySpd-=.1),this.ySpd<0&&(this.ySpd-=.02),this.vectorMovement()}}class Stage{constructor(){}getBgTilesMapPatterns(e){let s=[1,,9,3,8,4,0,,,,,,,,,,,2,1,,,,,,,,4,0,,,,,,,,,,,7,1,,,,,,,5,0,,,,,,,,,,3,1,,,,,,,9,0,,,,,,,,,,3,1,,,,,,,,9,0,,,,,,,,,3,1,,,,,,,,,9,0,,,,,,,,,7,1,,,,,,,,,5,0,,,,,,,,,7,1,,,,,,,,5,0,,,,,,,,,3,1,,,,,,,,9,0,,,,,,,,,,2,1,,,,,,,,,4,0,,,,,,,,,,7,1,,,,,,,,9,0,,,,,,,,,,2,1,,,,,,,,5,0,,,,,,,,,,,7,1,,,,,,9,0,,,,,,,,,,,,2,1,,,,,,5,0,,,,,,,,,,,,,7,1,,,,9,0,,,,,,,,,,,,,,7,1,,,,9,0,,,,,,,,,,,,,,7,1,,,,5,0,,,,,,,,,,,,,,2,1,,6,5,0,,,,,,,,,,,,,,,,2,1,0,,,,,,,,,,,,,,,,,,,2,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,3,4,0,,,,,,,,,,,,,,,,,3,1,,8,,4,0,,,,,,,,,,,,,,7,1,,,,9,0,,,,,,,,,,,,,3,1,,,,,9,0,,,,,,,,,,,,,7,1,,,,,9,0,,,,,,,,,,,,3,1,,,,,,,4,0,,,,,,,,,,3,1,,,,,,,,,4,0,,,,,,,,,7,1,,,,,,,,,9,0,,,,,,,,3,1,,,,,,,,,,,4,0,,,,,,,2,6,1,,,,,,,,6,,5,0,,,,,,,,,2,1,,,,,,9,0,,,,,,,,,,,,,7,1,,,,,9,0,,,,,,,,,,,,,7,1,,,,,5,0,,,,,,,,,,,,,2,1,,,,9,0,,,,,,,,,,,,,,,7,1,,,9,0,,,,,,,,,,,,,,,7,1,,,9,0,,,,,,,,,,,,,,,7,1,,,9,0,,,,,,,,,,,,,,,7,1,,,,4,0,,,,,,,,,,,,,,7,1,,,,9,0,,,,,,,,,,,,,3,1,,,,,9,0,,,,,,,,,,,,,7,1,,,,,9,0,,,,,,,,,,,,3,1,,,,,,,4,0,,,,,,,,,,3,1,,,,,,,,,4,0,,,,,,,,,7,1,,,,,,,,,9,0,,,,,,,,3,1,,,,,,,,,,,4,0,,,,,,,7,1,,,,,,,,,,,9,0,,,,,,,7,1,,,,,,,,,,,9,0,,,,,,3,1,,,,,,,,,,,,9,0,,,,,3,1,,,,,,,,,,,,,,4,0,,,,7,1,,,,,,,,,,,,,,,4,0,,3,1,,,,,,,,,,,,,,,,,4,3,1,,,,,,,,,,,,,,,,,,9,7,1,,,,,,,,,,,,,,,,,,9,7,1,,,,,,,,,,,,,,,,,,9,2,1,,,,,,,,,,,,,,,,,,5,0,2,1,,,,,,,,,,,,,,,,9,0,,,2,6,1,,,,,,,,,,,,,,5,0,,,,,2,1,,,,,,,,,,,,9,0,,,,,,,7,1,,,,,,,,,,6,5,0,,,,,,3,1,,,,,,,,,,9,0,,,,,,,,7,1,,,,,,,,,,9,0,,,,,,,3,1,,,,,,,,,,,,4,0,,,,3,8,1,,,,,,,,,,,,,,4,0,,3,1,,,,,,,,,,,,,,,,5,0,,1,,,,,,,,,,,,,6,,,5,0,,,1,,,,,,,,,,,,9,0,,,,,,,1,,,,,,,,,,,,,4,0,,,,,,1,,,,,,,,,,,,,,8,,4,0,,,1,,,,,,,,,,,,,,,,,4,0,,1,,,,,,,,,,,,,,,,6,5,0,,1,,,,,,,,,,,,,,,5,0,,,,1,,,,,,,,,,,,,,9,0,,,,,2,6,1,,,,,,,,,,,,5,0,,,,,,,2,1,,,,,,,,,,,4,0,,,,,,,,2,1,,,,,,,,,,,4,0,,,,,,,,7,1,,,,,,,,,,9,0,,,,,,,,7,1,,,,,,,,,,9,0,,,0],i=0;for(let t=0;t<s.length;t++)i=void 0===s[t]?i:s[t],s.splice(t,1,i);let h={};for(let t=0;t<s.length;t+=e)h[1+t/e]=s.slice(s.length-e*(1+t/e),s.length-e*(t/e));return h}init(t,e,s){this._displayW=e.width,this._displayH=e.height,this._tileSize=e.tileSize,this._tileQty=e.tileQty,this.patterns=this.getBgTilesMapPatterns(this._tileQty),this.bg={},this.bg.queue=[],this.bg.pattern=[...this.patterns[1]],this.bg.image=t,this.bg.image.w=t.fullW,this.bg.image.h=t.h,this.bg.imageCols=this.bg.image.width/this._tileSize,this.bg.palette=8,this.bg.speed=.5,this.bg.rows=new Array(16).fill(-8).map((t,e)=>t+8*e),this.bg.tileSize=this._tileSize,this.bg.numCols=this._displayW/this._tileSize,this.bg.tileQty=this._tileQty,this.bg.changePattern=!1,this.events=this.getEventsFn(s,this.patterns,this.bg)}getEventsFn(t,e,s){let i=new Array(5**6).fill(t=>t);return i[0]=()=>t.free("Player","Players"),i[145]=()=>t.free("Tank",{x:55,carryItem:!0}),i[300]=()=>t.free("Sniper",{x:40,alt:!0}),i[400]=()=>t.free("SinePop",{phase:-1}),i[410]=()=>t.free("SinePop",{phase:-1}),i[420]=()=>t.free("SinePop",{phase:-1}),i[430]=()=>t.free("SinePop",{phase:-1}),i[440]=()=>t.free("SinePop",{phase:-1}),i[550]=()=>{s.queue.push(...e[2],...e[3]),t.free("Sniper",{x:120,alt:!0})},i[560]=()=>t.free("Fatty",{side:1,y:1,alt:!0}),i[590]=()=>t.free("Fatty",{side:1,y:21,alt:!0}),i[620]=()=>t.free("Fatty",{side:1,y:41,alt:!0}),i[660]=()=>t.free("Tank",{x:52}),i[750]=()=>t.free("Sniper",{alt:!0}),i[820]=()=>t.free("SinePop",{phase:1}),i[830]=()=>t.free("SinePop",{phase:1}),i[840]=()=>t.free("SinePop",{phase:1}),i[850]=()=>t.free("SinePop",{phase:1}),i[860]=()=>t.free("SinePop",{phase:1}),i[880]=()=>t.free("Tank",{x:104,carryItem:!0}),i[1e3]=()=>t.free("Sniper"),i[1020]=()=>t.free("Sniper",{x:30}),i[1040]=()=>t.free("Sniper",{x:130}),i[1080]=()=>t.free("Boat",{x:145,side:-1}),i[1140]=()=>t.free("Boat",{x:20,side:1}),i[1200]=()=>{t.free("Fatty",{side:1}),t.free("Fatty",{side:-1}),s.speed+=.25},i[1300]=()=>s.speed+=.25,i[1400]=()=>{s.speed+=.25,t.free("Assaulter",{x:130})},i[1450]=()=>s.speed+=.25,i[1550]=()=>{s.speed+=.25,t.free("Assaulter",{x:30})},i[1650]=()=>s.speed+=.25,i[1700]=()=>t.free("Assaulter",{carryItem:!0}),i[1750]=()=>s.speed+=.25,i[1780]=()=>t.free("SinePop",{phase:-1}),i[1790]=()=>t.free("SinePop",{phase:-1}),i[1800]=()=>t.free("SinePop",{phase:-1}),i[1810]=()=>t.free("SinePop",{phase:-1}),i[1820]=()=>t.free("SinePop",{phase:-1}),i[1850]=()=>s.speed+=.25,i[1910]=()=>t.free("Sniper",{x:30}),i[1920]=()=>t.free("Sniper",{x:50}),i[1930]=()=>t.free("Sniper",{x:70}),i[1940]=()=>t.free("Sniper",{x:90}),i[1950]=()=>t.free("Sniper",{x:110}),i[1960]=()=>t.free("Sniper",{x:130}),i[2070]=()=>s.queue.push(...e[4],...e[5]),i[2150]=()=>t.free("Tank",{x:105}),i[2180]=()=>t.free("Tank",{x:132}),i[2200]=()=>t.free("Tank",{x:95,carryItem:!0}),i[2220]=()=>t.free("Tank",{x:117}),i[2300]=()=>{game.fade.dir="fadeIn",game.fade.speed=2,game.fade.layer=0},i[2350]=()=>{s.palette=9,game.fade.dir="fadeOut"},i[2400]=()=>{game.fade.speed=1,game.fade.layer="top"},i[2401]=()=>{t.free("BigTank"),game.sfxFlags.bigTank=!0},i[3001]=()=>{t.free("BigTank",{palette:6}),game.sfxFlags.bigTank=!0},i[3300]=()=>{game.fade.dir="fadeIn",game.fade.speed=2,game.fade.layer=0},i[3350]=()=>{s.palette=2,game.fade.dir="fadeOut"},i[3400]=()=>{game.fade.speed=1,game.fade.layer="top"},i[3600]=()=>(debug.gameReset(),"stop"),i}}class Engine{constructor(){this.ups=60}needs(t,e){this.callUpdate=t,this.callRender=e}start(){this.paused=!1,this.timeAcc=0,this.renderAcc=0,this.slice=1e3/this.ups,this.oneFrameInMs=1e3/60,this.delta=0,this.lastStamp=performance?.now?performance.now():(new Date).getTime(),window.requestAnimationFrame(t=>this.loop(t))}loop(t){if(!this.paused){for(this.delta=t-this.lastStamp,this.lastStamp=t,this.timeAcc+=this.delta;this.timeAcc>this.slice;)this.callUpdate(),this.timeAcc-=this.slice,this.renderAcc+=this.slice;this.renderAcc>=this.oneFrameInMs&&(this.callRender(),this.renderAcc=0),this.paused||window.requestAnimationFrame(t=>this.loop(t))}}pause(){if(!this.paused)return this.paused=!0;this.paused&&(this.callUpdate(),this.callRender())}}class Input{constructor(){this.enabled=!0,this.raw=new Array(5).fill(0),this.buttons=new Array(5).fill(0),window.addEventListener("keydown",t=>{this.keyToRaw(t.code,this.raw,1),t.code.includes("Arrow")&&t.preventDefault()}),window.addEventListener("keyup",t=>{this.keyToRaw(t.code,this.raw,0)}),window.addEventListener("visibilitychange",t=>{"hidden"===t.target.visibilityState&&(this.raw.fill(0),engine.pause())});let t=document.querySelector(".shot"),e=document.querySelector(".analog");t.addEventListener("touchstart",()=>this.raw[4]=1),t.addEventListener("touchend",()=>this.raw[4]=0),e.addEventListener("touchstart",t=>this.analogMove(t.targetTouches[0],t,this.raw)),e.addEventListener("touchmove",t=>this.analogMove(t.targetTouches[0],t,this.raw)),e.addEventListener("touchend",()=>this.raw.splice(0,4,0,0,0,0))}analogMove(t,e,s){var i=t.clientX-t.target.offsetLeft-t.target.clientWidth/2,t=t.clientY-t.target.offsetTop-t.target.clientHeight/2;i<=-25?s[3]=1:s[1]=1,t<=-25?s[0]=1:s[2]=1,-25<i&&i<25&&(s[3]=s[1]=0),-25<t&&t<25&&(s[0]=s[2]=0),e.returnValue=!1}gamepadToRaw(){this.gamepad=navigator.getGamepads()[0],this.gamepad&&(this.raw[0]=this.gamepad.buttons[12].pressed,this.raw[1]=this.gamepad.buttons[15].pressed,this.raw[2]=this.gamepad.buttons[13].pressed,this.raw[3]=this.gamepad.buttons[14].pressed,this.raw[4]=this.gamepad.buttons[1].pressed)}keyToRaw(t,e,s){switch(t){case"ArrowUp":return e[0]=s;case"ArrowRight":return e[1]=s;case"ArrowDown":return e[2]=s;case"ArrowLeft":return e[3]=s;case"KeyZ":return e[4]=s}}updateButtons(){if(!this.enabled)return this.buttons.fill(0);for(const t in this.raw)this.raw[t]&&this.buttons[t]<2&&this.buttons[t]++,this.raw[t]||(this.buttons[t]=0)}}class Game{constructor(){this.objects=new Map(Object.entries({Floor:[],E_Land:[],E_Air:[],Parts:[],Pickups:[],pBullets:[],Players:[],eBullets:[],Hud:[]})),this.queuedFns=[],this.sfxFlags={},this.fade={}}needs(t,e,s,i,h,a){this.math=t,this.stage=e,this.displayHeight=h,this.pool=s,this.input=i,this.audioPlayer=a}init(){for(var[t,e]of game.objects)e.length=0;this.stopFlag=!1,this.iteration=0,this.queuedFns.length=0,this.resetCounter=0,this.playersArr=this.objects.get("Players"),this.pBulletsArr=this.objects.get("pBullets"),this.airHazardsGroup=[this.objects.get("E_Air"),this.objects.get("eBullets")],this.pickupsGroup=[this.objects.get("Pickups")],this.enemiesGroup=[this.objects.get("E_Air"),this.objects.get("E_Land")],this.fade={opacity:100,color:"#000",dir:"fadeOut",speed:1,layer:"top"}}updateFade(t){switch(t.dir){case"fadeOut":0<=t.opacity&&(t.opacity-=t.speed);break;case"fadeIn":t.opacity<=100&&(t.opacity+=t.speed)}101!=t.opacity&&-1!=t.opacity||(t.dir="none")}update(){if(this.updateFade(this.fade),this.input.gamepadToRaw(),this.input.updateButtons(),"stop"!==this.stage.events[this.iteration]()){this.iteration++,this.scrollBackground(this.stage.bg.speed);for(var[t,e]of this.objects)e.forEach(t=>this.updateEntity(t));this.freeQueued(),this.testCollision(this.playersArr,this.airHazardsGroup,(t,e)=>{e.hp=t.hp=0,t.explode=!0,this.sfxFlags.die=!0}),this.testCollision(this.playersArr,this.pickupsGroup,(t,e)=>{e.hp=0,e.explode=!0,this.queuedFns.push(["Particle",{x:t.x,y:t.y,colors:e.colors,beheavior:2}]),this.sfxFlags.item=!0}),this.testCollision(this.pBulletsArr,this.enemiesGroup,(t,e)=>{t.hp=0,e.hp--,e.hitState=1,e.hp<=0&&(e.explode=!0,this.sfxFlags.xplos=!0)}),this.handleDeadEntities(),this.freeQueued(),this.audioPlayer.playSfx(this.sfxFlags);for(const s in this.sfxFlags)this.sfxFlags[s]=!1;this.playersArr[0]||(this.resetCounter++,50===this.resetCounter&&(this.fade.dir="fadeIn"),150===this.resetCounter&&debug.gameReset())}}testCollision(t,e,s){if(t.length)for(var i of t)for(var h of e){if(!i.hp)break;for(var a of h)if(a.hp&&this.collisionBetween(i,a)&&(s(i,a),!i.hp))break}}collisionBetween(t,e){return e.hitbox[0]<t.hitbox[1]&&t.hitbox[0]<e.hitbox[1]&&e.hitbox[2]<t.hitbox[3]&&t.hitbox[2]<e.hitbox[3]}scrollBackground(i){this.stage.bg.rows.forEach((t,e)=>{if(this.stage.bg.rows[e]+=i,this.stage.bg.rows[e]>=this.displayHeight){if(this.stage.bg.rows[e]-=this.displayHeight+this.stage.bg.tileSize,e===this.stage.bg.rows.length-1&&this.stage.bg.queue.length>=this.stage.bg.tileQty&&(this.stage.bg.changePattern=!0),this.stage.bg.changePattern)for(let t=0;t<this.stage.bg.numCols;t++){var s=t+e*this.stage.bg.numCols;this.stage.bg.pattern[s]=this.stage.bg.queue[s]}this.stage.bg.changePattern&&!e&&(this.stage.bg.changePattern=!1,this.stage.bg.queue.splice(0,this.stage.bg.numCols*this.stage.bg.rows.length))}})}updateEntity(t){if(t.hitState=0,t.timerCount(50,7)&&(t.deadBound=!0),t.dying)return t.killAnimation();t.updateData?.(this.input.buttons),t.updatePos?.(this.input.buttons),t instanceof Player&&t.fixOutOfBounds(),t.deadBound&&this.testDeadBound(t),t.hitbox&&t.updateHitbox(),t.opacity<0&&(t.opacity=0)}testDeadBound(t){t.deadBound&&(t.y>=t.displayHeight+t.height/2||t.y<=0-t.height/2||t.x>=t.displayWidth+t.width/2||t.x<=0-t.width/2)&&(t.hp=0)}handleDeadEntities(){for(var[t,e]of this.objects)for(let t=e.length-1;-1<t;t--)e[t].hp<=0&&this.kill(e[t]),e[t].free&&(e[t].releaseItem(),e.splice(t,1))}kill(t){if(!t.dying){if(t.killAnimation&&t.explode)return t.killAnimation();t.explode&&t.spawnParticles(t.explosionData()),t instanceof Player&&t.positionFar(),t.free=!0}}freeQueued(){this.queuedFns.forEach(t=>this.pool.free(...t)),this.queuedFns.length=0}}class AudioPlayer{constructor(){this.zzfx=zzfx,this.enable=!0}playSfx(t){if(this.enable){if(t.die)return this.enable=!1,void this.zzfx(void 0,void 0,843,.01,.13,.58,2,5,1,void 0,void 0,void 0,void 0,1.4,void 0,.5,.49,.47,.12,.29);t.pShot&&this.zzfx(.1,void 0,1450,void 0,.01,0,2,.37,-42,void 0,-18,.19,void 0,void 0,-.8,void 0,void 0,.63,.01,.81),t.xplos&&this.zzfx(.5,void 0,894,void 0,.05,.35,1,3.68,.7,.8,void 0,void 0,.04,1.3,void 0,.6,void 0,.1,.05),t.xplos_L&&this.zzfx(.5,void 0,894,void 0,.05,.35,1,3.68,.7,.8,void 0,void 0,.04,1.3,void 0,.6,void 0,.1,.05),t.xplos_S&&this.zzfx(.1,void 0,79,.02,.05,.13,4,.16,.2,.8,void 0,void 0,void 0,.1,void 0,.1,void 0,.5,void 0,.27),t.eShot&&this.zzfx(.05,void 0,346,void 0,void 0,.01,void 0,1.64,-4.1,void 0,void 0,void 0,void 0,.9,void 0,void 0,.04,.95,.08),t.cannon&&this.zzfx(.1,void 0,240,void 0,.01,.17,2,.03,-82,void 0,void 0,void 0,void 0,.7,void 0,.1,void 0,.51,.03,.12),t.item&&this.zzfx(.3,void 0,1226,void 0,.19,.11,void 0,1.25,4.9,-.2,void 0,.05,void 0,void 0,void 0,void 0,.14,.51,.05),t.bigTank&&this.zzfx(.4,void 0,50,.53,.09,.36,1,2.8,void 0,void 0,void 0,void 0,void 0,.6,13,.3,.52,.39,.34)}}}class Display{constructor(){this.width=160,this.height=120,this.tileSize=8,this.tileQty=320,this.c=document.querySelector("canvas"),this.ctx=this.c.getContext("2d"),this.hitboxes=!1,this.setScaleAndResize(),this.pixelatedLook(this.ctx),window.addEventListener("resize",()=>{this.setScaleAndResize(),this.pixelatedLook(this.ctx),this.render(stage.bg,game.objects,game.fade)}),window.addEventListener("touchmove",t=>t.preventDefault(),{passive:!1})}setScaleAndResize(t){this.scale=M.min(M.trunc(window.innerWidth/this.width),M.trunc(window.innerHeight/this.height)),this.c.width=this.scale*this.width,this.c.height=this.scale*this.height}render(t,e,s){this.renderBackground(),this.renderScrollingBg(t),"top"===s.layer?(this.renderGameObjects(e),this.renderFade(s)):(this.renderFade(s),this.renderGameObjects(e)),this.hitboxes&&this.renderHitboxes(e)}renderBackground(){this.ctx.fillStyle="#0062c4",this.ctx.fillRect(0,0,this.c.width,this.c.height)}renderScrollingBg(i){let h=0;i.rows.forEach((t,e)=>{var s=i.rows[e]*this.scale;for(let t=0;t<this.width;t+=this.tileSize)i.rows[e]<=-this.tileSize||0!==i.pattern[h]&&this.ctx.drawImage(i.image,i.pattern[h]*this.tileSize+i.image.width*i.palette-this.tileSize,0,this.tileSize,this.tileSize,t*this.scale,s,this.tileSize*this.scale,this.tileSize*this.scale),h++})}renderGameObjects(t){for(var[e,s]of t)s.forEach(t=>{this.ctx.save(),this.ctx.globalAlpha=t.opacity/100,this.ctx.translate(t.x*this.scale,t.y*this.scale),this.ctx.rotate(t.rotation),t instanceof Particle||t instanceof EnemyBullet?(this.ctx.fillStyle=t.currentColor||"#fff",this.ctx.fillRect(-(t.scale*this.scale)/2,-(t.scale*this.scale)/2,t.scale*this.scale,t.scale*this.scale)):this.ctx.drawImage(t.image,t.image.sWidth*t.palette,t.image.height*t.hitState,t.image.sWidth,t.image.height,-(t.image?.sWidth*t.scale*this.scale)/2,-(t.image?.height*t.scale*this.scale)/2,t.image?.sWidth*t.scale*this.scale,t.image?.height*t.scale*this.scale),this.ctx.restore()})}renderFade(t){t.opacity<0||100<t.opacity||(this.ctx.globalAlpha=t.opacity/100,this.ctx.fillStyle=t.color,this.ctx.fillRect(0,0,this.c.width,this.c.height),this.ctx.globalAlpha=1)}pixelatedLook(t){t.mozImageSmoothingEnabled=0,t.webkitImageSmoothingEnabled=0,t.msImageSmoothingEnabled=0,t.imageSmoothingEnabled=0}renderHitboxes(t){for(var[e,s]of t)s.forEach(t=>{t.hitbox&&(this.drawLine(t.hitbox[0],t.hitbox[2],"start","white"),this.drawLine(t.hitbox[1],t.hitbox[2]),this.drawLine(t.hitbox[1],t.hitbox[3]),this.drawLine(t.hitbox[0],t.hitbox[3]),this.drawLine(t.hitbox[0],t.hitbox[2]))})}drawLine(t,e,s,i){if(s)return this.ctx.strokeStyle=i,this.ctx.beginPath(),void this.ctx.moveTo(t*this.scale,e*this.scale);this.ctx.lineTo(t*this.scale,e*this.scale),this.ctx.stroke()}}class Pool{constructor(){this.type={},this.resources=[[1,Player,4],[9,Assaulter,0],[9,Boat,1],[9,Tank,2],[9,Fatty,22],[9,Sniper,5],[9,SinePop,6],[9,Item,7],[18,PlayerBullet,8],[1,BigTank,55],[35,EnemyBullet],[500,Particle]]}needs(t,e){this.assets=t,this.gameObjects=e,this.resources.forEach(t=>this.fillWith(t))}fillWith([t,e,s]){this.type[e.name]=new Array(t).fill(0).map(()=>new e(this.assets[s]))}free(e,s,i){var h=this.type[e].length;for(let t=0;t<h;t++)if(this.type[e][t].free)return this.type[e][t].free=!1,this.type[e][t].parentReset(s),void this.gameObjects.get(i||this.type[e][t].layer).push(this.type[e][t])}}const customMath=new CustomMath,input=new Input,display=new Display,audioPlayer=new AudioPlayer,pool=new Pool,stage=new Stage,engine=new Engine,game=new Game,assets=new Assets;function connectInitStart(){pool.needs(assets,game.objects),engine.needs(()=>game.update(),()=>display.render(stage.bg,game.objects,game.fade)),game.needs(customMath,stage,pool,input,display.height,audioPlayer),stage.init(assets.bg,display,pool),game.init(),engine.start()}assets.load(connectInitStart);const debug={gameReset(){audioPlayer.enable=!0;for(const t in pool.type)pool.type[t].forEach(t=>t.free=!0);stage.init(assets.bg,display,pool),game.init(),engine.pause(),setTimeout(()=>engine.start(),200)},toggleHitboxes(){display.hitboxes=display.hitboxes?void 0:"hitboxes",display.render(stage.bg,game.objects,game.fade)},enginePause(){engine.pause()},engineStart(){engine.start()},toggleFullScreen(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}};window.addEventListener("keydown",t=>{"KeyP"===t.code&&debug.enginePause(),"Enter"===t.code&&debug.engineStart(),"KeyH"===t.code&&debug.toggleHitboxes(),"KeyR"===t.code&&debug.gameReset()});</script>